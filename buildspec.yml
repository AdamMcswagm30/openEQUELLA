version: 0.2
env:
  variables:
    AUTOTEST_CONFIG: codebuild.conf
phases:
  install:
    commands:
      - /etc/init.d/postgresql start
      - su -l -c "psql -c \"CREATE USER equellatests WITH PASSWORD 'password';\"" postgres
      - su -l -c "psql -c 'CREATE DATABASE equellatests WITH OWNER = equellatests;'" postgres
  pre_build:
    commands:
      - curl -OL https://s3.amazonaws.com/edalexdev/equella_artifacts/latest/equella-installer-6.5.zip
  build:
    commands:
      - cd IntegTester/ps
      - npm install
      - bower --allow-root install
      - npm run build
      - cd $CODEBUILD_SRC_DIR
      - sbt IntegTester/assembly
      - java -jar IntegTester/target/scala-2.12/IntegTester-assembly-1.0.jar &
      - sbt -Dsbt.log.noformat=true installEquella startEquella
      - sbt -Dsbt.log.noformat=true configureInstall setupForTests Tests/test
      - sbt -Dsbt.log.noformat=true coverageReport
  post_build:
    commands:
      - sbt -Dsbt.log.noformat=true collectArtifacts
artifacts:
  files:
    - target/test-artifacts.zip
  discard-paths: yes
